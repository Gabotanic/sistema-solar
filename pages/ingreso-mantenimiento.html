<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingreso de Mantenimiento - MANTENSOLAR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <style>
        :root {
            --primary-color: #34d399; /* Un verde más vibrante como en la imagen */
            --primary-color-dark: #10b981;
            --light-gray: #f3f4f6;
            --dark-text: #1f2937;
            --medium-text: #4b5563;
        }

        body {
            background-color: var(--light-gray);
        }

        .main-content {
            padding-bottom: 100px; /* Restaurar padding para el botón */
            position: relative; /* Para contener el botón */
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background: var(--light-gray);
            /* Ya no necesita position relative ni padding-bottom extra */
        }

        .form-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .form-header .back-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-text);
        }

        .form-header h1 {
            flex-grow: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin: 0;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .checkbox-group:last-child {
            border-bottom: none;
        }

        .checkbox-group label {
            color: var(--medium-text);
        }

        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: var(--primary-color);
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }

        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group input[type="number"] {
             width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--medium-text);
            font-size: 13px;
        }

        .photo-upload-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: #eefcf8;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            margin-bottom: 15px;
        }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .photo-preview-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--medium-text);
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .final-button-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: white;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); /* Añadir sombra aquí */
        }

        .final-button {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }
        .final-button:hover {
            background-color: var(--primary-color-dark);
        }

    </style>
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <div class="form-container">
                <div class="form-header">
                    <button class="back-button" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></button>
                    <h1>Informe para: <span id="cliente-nombre-header"></span></h1>
                </div>

                <form id="mantenimiento-form">
                    <!-- Diagnóstico General -->
                    <div class="form-section">
                        <h2>Diagnóstico General</h2>
                        <div class="checkbox-group">
                            <label for="inspeccion-visual">Inspección visual de los paneles</label>
                            <input type="checkbox" id="inspeccion-visual" name="inspeccion-visual">
                        </div>
                        <div class="checkbox-group">
                            <label for="verificacion-conexiones">Verificación de las conexiones</label>
                            <input type="checkbox" id="verificacion-conexiones" name="verificacion-conexiones">
                        </div>
                        <div class="checkbox-group">
                            <label for="prueba-rendimiento">Prueba de rendimiento eléctrico</label>
                            <input type="checkbox" id="prueba-rendimiento" name="prueba-rendimiento">
                        </div>
                        <div class="checkbox-group">
                            <label for="estado-inversor">Estado del inversor</label>
                            <input type="checkbox" id="estado-inversor" name="estado-inversor">
                        </div>
                        <div class="checkbox-group">
                            <label for="cableado-conexiones">Cableado y conexiones</label>
                            <input type="checkbox" id="cableado-conexiones" name="cableado-conexiones">
                        </div>
                    </div>

                    <!-- Notas adicionales -->
                    <div class="form-section">
                        <h2>Notas adicionales</h2>
                        <div class="form-group">
                            <textarea id="notas-adicionales" name="notas-adicionales" placeholder="Añade aquí tus observaciones..."></textarea>
                        </div>
                    </div>

                    <!-- Mediciones Eléctricas -->
                    <div class="form-section">
                        <h2>Mediciones Eléctricas</h2>
                        <div class="measurements-grid">
                            <div class="form-group">
                                <label for="voltaje-antes">Voltaje (V) - Antes</label>
                                <input type="number" id="voltaje-antes" name="voltaje-antes" step="0.1" placeholder="V">
                            </div>
                            <div class="form-group">
                                <label for="voltaje-despues">Voltaje (V) - Después</label>
                                <input type="number" id="voltaje-despues" name="voltaje-despues" step="0.1" placeholder="V">
                            </div>
                            <div class="form-group">
                                <label for="corriente-antes">Corriente (A) - Antes</label>
                                <input type="number" id="corriente-antes" name="corriente-antes" step="0.1" placeholder="A">
                            </div>
                            <div class="form-group">
                                <label for="corriente-despues">Corriente (A) - Después</label>
                                <input type="number" id="corriente-despues" name="corriente-despues" step="0.1" placeholder="A">
                            </div>
                            <div class="form-group">
                                <label for="potencia-antes">Potencia (W) - Antes</label>
                                <input type="number" id="potencia-antes" name="potencia-antes" step="1" placeholder="W">
                            </div>
                            <div class="form-group">
                                <label for="potencia-despues">Potencia (W) - Después</label>
                                <input type="number" id="potencia-despues" name="potencia-despues" step="1" placeholder="W">
                            </div>
                            <div class="form-group">
                                <label for="resistencia-aislamiento-antes">Resistencia Aislamiento (MΩ) - Antes</label>
                                <input type="number" id="resistencia-aislamiento-antes" name="resistencia-aislamiento-antes" step="0.1" placeholder="MΩ">
                            </div>
                            <div class="form-group">
                                <label for="resistencia-aislamiento-despues">Resistencia Aislamiento (MΩ) - Después</label>
                                <input type="number" id="resistencia-aislamiento-despues" name="resistencia-aislamiento-despues" step="0.1" placeholder="MΩ">
                            </div>
                        </div>
                    </div>

                    <!-- Registro Fotográfico -->
                    <div class="form-section">
                        <h2>Registro Fotográfico</h2>
                        <input type="file" id="foto-antes-input" name="foto-antes" accept="image/*" onchange="previewImage(this, 'preview-antes')" hidden>
                        <label for="foto-antes-input" class="photo-upload-btn">Añadir foto (Antes)</label>
                        <div id="preview-antes" class="photo-preview-grid"></div>
                        
                        <input type="file" id="foto-despues-input" name="foto-despues" accept="image/*" onchange="previewImage(this, 'preview-despues')" hidden>
                        <label for="foto-despues-input" class="photo-upload-btn">Añadir foto (Después)</label>
                        <div id="preview-despues" class="photo-preview-grid"></div>
                    </div>

                    <!-- Registro Termográfico -->
                    <div class="form-section">
                        <h2>Registro Termográfico</h2>
                        <div class="tabs">
                            <div class="tab active" onclick="openTab(event, 'paneles')"><i class="fas fa-plus"></i> Paneles</div>
                            <div class="tab" onclick="openTab(event, 'conexiones')"><i class="fas fa-plus"></i> Conexiones</div>
                            <div class="tab" onclick="openTab(event, 'inversor')"><i class="fas fa-plus"></i> Inversor</div>
                        </div>

                        <div id="paneles" class="tab-content active">
                            <input type="file" id="termo-paneles-input" name="termo-paneles" accept="image/*" onchange="previewImage(this, 'preview-termo-paneles')" hidden>
                            <label for="termo-paneles-input" class="photo-upload-btn">Añadir foto termográfica de Paneles</label>
                            <div id="preview-termo-paneles" class="photo-preview-grid"></div>
                        </div>
                        <div id="conexiones" class="tab-content">
                           <input type="file" id="termo-conexiones-input" name="termo-conexiones" accept="image/*" onchange="previewImage(this, 'preview-termo-conexiones')" hidden>
                           <label for="termo-conexiones-input" class="photo-upload-btn">Añadir foto termográfica de Conexiones</label>
                           <div id="preview-termo-conexiones" class="photo-preview-grid"></div>
                        </div>
                        <div id="inversor" class="tab-content">
                            <input type="file" id="termo-inversor-input" name="termo-inversor" accept="image/*" onchange="previewImage(this, 'preview-termo-inversor')" hidden>
                            <label for="termo-inversor-input" class="photo-upload-btn">Añadir foto termográfica de Inversor</label>
                            <div id="preview-termo-inversor" class="photo-preview-grid"></div>
                        </div>
                    </div>

                    <!-- Hidden fields for other data -->
                    <input type="hidden" id="cliente-nombre" name="cliente-nombre">
                    <input type="hidden" id="cliente-direccion" name="cliente-direccion">
                    <input type="hidden" id="fecha-visita" name="fecha-visita">

                </form>
            </div>
        </main>
        
        <div class="final-button-container">
            <button class="final-button" onclick="generarInforme()">
                Finalizar y Generar Informe
            </button>
        </div>
    </div>

    <script>
        // Set client name and date
        const urlParams = new URLSearchParams(window.location.search);
        const clienteNombre = urlParams.get('cliente') || 'No especificado';
        const clienteDireccion = urlParams.get('direccion') || 'No especificada';
        
        document.getElementById('cliente-nombre-header').textContent = clienteNombre;
        document.getElementById('cliente-nombre').value = clienteNombre;
        document.getElementById('cliente-direccion').value = clienteDireccion;
        
        const hoy = new Date();
        const fechaFormateada = hoy.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('fecha-visita').value = fechaFormateada;


        // Image preview function
        function previewImage(input, previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'photo-preview-item';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewItem.appendChild(img);
                    previewContainer.innerHTML = ''; // Clear previous preview
                    previewContainer.appendChild(previewItem);
                }
                reader.readAsDataURL(file);
            }
        }

        // Tabs function
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Function to gather form data
        function obtenerDatosFormulario() {
            const form = document.getElementById('mantenimiento-form');
            const formData = new FormData(form);
            const datos = {};

            for (let [key, value] of formData.entries()) {
                if (form.elements[key].type === 'checkbox') {
                    datos[key] = form.elements[key].checked;
                } else if (value instanceof File) {
                    // For files, we will handle them with a FileReader in the next step
                    // For now, we just note that they exist
                    if(value.size > 0) {
                         datos[key] = "file_attached";
                    }
                }
                else {
                    datos[key] = value;
                }
            }
            return datos;
        }

        // Generate Report function
        function generarInforme() {
            const datos = obtenerDatosFormulario();
            
            // For now, we will pass data via URL params.
            // A more robust solution would use localStorage or a server.
            // Image data cannot be passed through URL, the report will show placeholders.
            const queryString = new URLSearchParams(datos).toString();
            window.open(`../informe/codigo_informe.html?${queryString}`, '_blank');
        }
    </script>
</body>
</html> 